<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- DOM Element References ---
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const searchTermsInput = document.getElementById('search-terms-input');
    const runSearchBtn = document.getElementById('run-search-btn');
    const resultsSummary = document.getElementById('results-summary');
    const resultsOutput = document.getElementById('results-output');
    const openPdfBtn = document.getElementById('open-pdf-btn');
    const loadingModal = document.getElementById('loading-modal');
    const loadingText = document.getElementById('loading-text');
    const searchGroupsDropdown = document.getElementById('search-groups-dropdown');
    const newGroupNameInput = document.getElementById('new-group-name');
    const saveGroupBtn = document.getElementById('save-group-btn');
    const loadGroupBtn = document.getElementById('load-group-btn');
    const deleteGroupBtn = document.getElementById('delete-group-btn');
    const pageAddersContainer = document.getElementById('page-adders-container');
    const rangeStartInput = document.getElementById('range-start-input');
    const rangeEndInput = document.getElementById('range-end-input');
    const addRangeBtn = document.getElementById('add-range-btn');
    const addPageInput = document.getElementById('add-page-input');
    const addPageBtn = document.getElementById('add-page-btn');
    const notificationContainer = document.getElementById('notification-container');
    const confirmationModal = document.getElementById('confirmation-modal');
    const confirmationTitle = document.getElementById('confirmation-title');
    const confirmBtnYes = document.getElementById('confirm-btn-yes');
    const confirmBtnNo = document.getElementById('confirm-btn-no');

    // --- Application State ---
    let currentPdf = null;
    let matchedPageNumbers = [];
    let searchGroups = [];
    let db, auth, userId;
    let isAuthReady = false;
    let groupsCollectionRef;
    // Static App ID from the working example
    const appId = 'pdf-search-tool-v1'; 

    // --- Firebase Initialization ---
    async function initializeFirebase() {
        try {
            // **FIX**: Hardcoded the Firebase config from your working script
            const firebaseConfig = {
                apiKey: "AIzaSyBu50nNfswe73_JC96yB2wYPqiB1jqR1vw",
                authDomain: "pdf-search-tool-live.firebaseapp.com",
                projectId: "pdf-search-tool-live",
                storageBucket: "pdf-search-tool-live.appspot.com",
                messagingSenderId: "976932655448",
                appId: "1:976932655448:web:f7fe06ecc9aa3d1c5f552d",
                measurementId: "G-W9GPTLHY9V"
            };

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            groupsCollectionRef = collection(db, `/artifacts/${appId}/public/data/searchGroups`);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Authenticated with UID:", userId);
                    loadGroupsFromFirestore();
                } else {
                    console.log("User not signed in.");
                    isAuthReady = false;
                }
            });

            // **FIX**: Simplified to always sign in anonymously, like the working script
            await signInAnonymously(auth);

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showNotification("Could not connect to the collaborative service.", "error");
        }
    }
    
    // --- Core Application Logic ---

    async function handleFileSelect(event) {
        console.log("handleFileSelect: Fired.");
        const file = event.target.files[0];
        runSearchBtn.disabled = true;
        if (!file || file.type !== 'application/pdf') {
            fileInfo.textContent = 'Please select a valid PDF file.';
            currentPdf = null;
            return;
        }
        fileInfo.textContent = `File: ${file.name}`;
        const fileReader = new FileReader();
        fileReader.onload = async (e) => {
            setLoading(true, "Loading PDF...");
            try {
                const typedarray = new Uint8Array(e.target.result);
                currentPdf = await pdfjsLib.getDocument({ data: typedarray }).promise;
                console.log("handleFileSelect: PDF loaded successfully. currentPdf object:", currentPdf);
                runSearchBtn.disabled = false;
            } catch (error) {
                console.error("handleFileSelect: Error loading PDF:", error);
                fileInfo.textContent = 'Error: Could not load PDF. Check console for details.';
                currentPdf = null;
            } finally {
                setLoading(false);
            }
        };
        fileReader.readAsArrayBuffer(file);
    }

    async function runSearch() {
        console.log("runSearch: Fired. Checking currentPdf:", currentPdf);
        if (!currentPdf) {
            showNotification('Please select a PDF file first.', 'error');
            return;
        }
        const termsText = searchTermsInput.value.trim();
        if (!termsText) {
            showNotification('Please enter some search terms.', 'error');
            return;
        }
        
        const searchTerms = termsText.split(',').map(term => term.trim().toLowerCase().replace(/\s+/g, '')).filter(term => term.length > 0);
        
        if (searchTerms.length === 0) {
            showNotification('Please enter valid search terms.', 'error');
            return;
        }

        setLoading(true, "Searching PDF...");
        resultsOutput.innerHTML = ''; 
        resultsSummary.innerHTML = '';
        openPdfBtn.classList.add('hidden'); 
        pageAddersContainer.classList.add('hidden'); 
        const matchedPages = new Set(); 

        for (let i = 1; i <= currentPdf.numPages; i++) {
            setLoading(true, `Searching page ${i} of ${currentPdf.numPages}...`);
            const page = await currentPdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join('').toLowerCase().replace(/\s+/g, '');

            const isMatch = searchTerms.some(term => pageText.includes(term));
            if (isMatch) {
                matchedPages.add(page.pageNumber); 
            }
        }

        matchedPageNumbers = Array.from(matchedPages).sort((a,b) => a-b);
        await rerenderAllResults();
        updateResultsSummary();
        setLoading(false);
    }
    
    async function openFilteredPdfInNewTab() {
        if (!fileInput.files[0] || matchedPageNumbers.length === 0) {
            showNotification("No file or pages to open.", "error");
            return;
        }
        
        setLoading(true, "Creating new PDF...");
        try {
            const originalPdfBytes = await fileInput.files[0].arrayBuffer();
            const { PDFDocument } = PDFLib; 
            const pdfDoc = await PDFDocument.load(originalPdfBytes);
            const newPdfDoc = await PDFDocument.create();

            const pageIndices = matchedPageNumbers.map(n => n - 1).sort((a, b) => a - b);
            const copiedPages = await newPdfDoc.copyPages(pdfDoc, pageIndices);
            copiedPages.forEach(page => newPdfDoc.addPage(page));

            const newPdfBytes = await newPdfDoc.save();
            const blob = new Blob([newPdfBytes], { type: 'application/pdf' });
            const blobUrl = URL.createObjectURL(blob);
            window.open(blobUrl, '_blank');
        } catch (error) {
            console.error("Error creating filtered PDF:", error);
            showNotification("Error creating PDF. Check console.", "error");
        } finally {
            setLoading(false);
        }
    }
    
    // --- UI Rendering Functions ---

    async function renderPage(page, container) {
        const pageNum = page.pageNumber;
        const wrapper = document.createElement('div');
        wrapper.className = 'page-wrapper flex-shrink-0 w-64';
        wrapper.id = `page-wrapper-${pageNum}`;
        wrapper.dataset.pageNumber = pageNum;

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '&times;';
        removeBtn.className = 'remove-page-btn bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold hover:bg-red-700 transition-colors z-10';
        removeBtn.title = `Remove page ${pageNum}`;
        removeBtn.onclick = () => removePage(pageNum);
        
        const unscaledViewport = page.getViewport({ scale: 1.0 });
        const containerWidth = 256; // w-64 is 256px
        const scale = (containerWidth / unscaledViewport.width); 
        const viewport = page.getViewport({ scale: scale });

        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas mx-auto'; 
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const pageTitle = document.createElement('p');
        pageTitle.className = 'text-sm font-bold text-center text-slate-600 mb-1';
        pageTitle.textContent = `Page ${pageNum}`;

        wrapper.addEventListener('mouseenter', handleMouseEnter);
        wrapper.addEventListener('mouseleave', handleMouseLeave);
        
        wrapper.appendChild(removeBtn); 
        wrapper.appendChild(pageTitle); 
        wrapper.appendChild(canvas);
        container.appendChild(wrapper);

        await page.render({ canvasContext: context, viewport: viewport }).promise;
    }

    async function rerenderAllResults() {
        resultsOutput.innerHTML = '<p class="w-full px-2">Loading page previews...</p>'; 
        if (matchedPageNumbers.length > 0) {
            resultsOutput.innerHTML = '';
             for (const pageNum of matchedPageNumbers) {
                 const page = await currentPdf.getPage(pageNum);
                 await renderPage(page, resultsOutput);
             }
        } else {
             resultsOutput.innerHTML = '<p class="w-full px-2">No pages found or all pages have been removed.</p>';
        }
    }

    function removePage(pageNum) {
        const wrapperToRemove = document.getElementById(`page-wrapper-${pageNum}`);
        if (wrapperToRemove) wrapperToRemove.remove();
        matchedPageNumbers = matchedPageNumbers.filter(num => num !== pageNum);
        updateResultsSummary();
    }

    function updateResultsSummary() {
        if (matchedPageNumbers.length > 0) {
             const pageNumbersList = matchedPageNumbers.sort((a, b) => a - b);
             resultsSummary.innerHTML = `<p class="mb-2 font-semibold">${matchedPageNumbers.length} selected page(s).</p><div class="mb-2 text-sm text-slate-600 break-words">Pages: <strong>${pageNumbersList.join(', ')}</strong></div>`;
             openPdfBtn.classList.remove('hidden');
             pageAddersContainer.classList.remove('hidden'); 
        } else {
             resultsSummary.innerHTML = '';
             openPdfBtn.classList.add('hidden');
             pageAddersContainer.classList.add('hidden');
             resultsOutput.innerHTML = '<p class="w-full px-2">No pages found or all pages have been removed.</p>';
        }
    }
    
    // --- Page Adding Functions ---

    async function handleAddRange() {
        if (!currentPdf) return showNotification("Please load a PDF first.", "error");
        const start = parseInt(rangeStartInput.value, 10);
        const end = parseInt(rangeEndInput.value, 10);

        if (isNaN(start) || isNaN(end) || start > end) return showNotification("Invalid page range.", "error");
        if (start < 1 || end > currentPdf.numPages) return showNotification(`Pages must be between 1 and ${currentPdf.numPages}.`, "error");

        setLoading(true, "Adding page range...");
        const pagesToInclude = new Set(matchedPageNumbers);
        for (let i = start; i <= end; i++) pagesToInclude.add(i);
        matchedPageNumbers = Array.from(pagesToInclude).sort((a, b) => a - b);
        
        await rerenderAllResults();
        updateResultsSummary();
        rangeStartInput.value = '';
        rangeEndInput.value = '';
        setLoading(false);
    }
    
    async function handleAddSinglePage() {
        if (!currentPdf) return showNotification("Please load a PDF first.", "error");
        const pageNum = parseInt(addPageInput.value, 10);

        if (isNaN(pageNum)) return showNotification("Please enter a valid page number.", "error");
        if (pageNum < 1 || pageNum > currentPdf.numPages) return showNotification(`Page must be between 1 and ${currentPdf.numPages}.`, "error");

        setLoading(true, `Adding page ${pageNum}...`);
        const pagesToInclude = new Set(matchedPageNumbers);
        pagesToInclude.add(pageNum);
        matchedPageNumbers = Array.from(pagesToInclude).sort((a, b) => a - b);
        
        await rerenderAllResults();
        updateResultsSummary();
        addPageInput.value = '';
        setLoading(false);
    }

    // --- Search Group Functions (Firestore) ---

    function loadGroupsFromFirestore() {
        if (!isAuthReady) return;
        onSnapshot(groupsCollectionRef, (snapshot) => {
            searchGroups = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
            renderSearchGroupsDropdown();
        }, (error) => {
            console.error("Error listening to group changes: ", error);
            showNotification("Could not load shared groups.", "error");
        });
    }

    async function saveSearchGroup() {
        if (!isAuthReady) return showNotification("Not connected to collaborative service.", "error");
        const name = newGroupNameInput.value.trim();
        const terms = searchTermsInput.value.trim();
        if (!name) return showNotification("Please enter a name for the group.", "error");
        if (!terms) return showNotification("Please enter search terms to save.", "error");

        try {
            await addDoc(groupsCollectionRef, { name, terms });
            newGroupNameInput.value = '';
            showNotification(`Group "${name}" saved.`, "success");
        } catch (error) {
            console.error("Error saving group:", error);
            showNotification("Could not save group.", "error");
        }
    }

    function loadSearchGroup() {
        const selectedId = searchGroupsDropdown.value;
        const selectedGroup = searchGroups.find(g => g.id === selectedId);
        if (selectedGroup) {
            searchTermsInput.value = selectedGroup.terms;
        }
    }

    async function deleteSearchGroup() {
        if (!isAuthReady) return showNotification("Not connected to collaborative service.", "error");
        const selectedId = searchGroupsDropdown.value;
        if (!selectedId) return;

        const selectedGroup = searchGroups.find(g => g.id === selectedId);

        showConfirmation(`Delete the group "${selectedGroup.name}"?`, async () => {
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/searchGroups/${selectedId}`);
                await deleteDoc(docRef);
                showNotification(`Group "${selectedGroup.name}" deleted.`, "success");
            } catch (error) {
                console.error("Error deleting group: ", error);
                showNotification("Could not delete group.", "error");
            }
        });
    }
    
    function renderSearchGroupsDropdown() {
        const selectedValue = searchGroupsDropdown.value;
        searchGroupsDropdown.innerHTML = '<option value="">-- Select a Group --</option>';
        const sortedGroups = [...searchGroups].sort((a, b) => a.name.localeCompare(b.name));
        for (const group of sortedGroups) {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            searchGroupsDropdown.appendChild(option);
        }
        searchGroupsDropdown.value = selectedValue;
    }

    // --- Utility Functions (UI Helpers) ---
    function setLoading(isLoading, text = "Loading...") {
        loadingText.textContent = text;
        loadingModal.classList.toggle('hidden', !isLoading);
    }

    function showNotification(message, type = 'success') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        notificationContainer.appendChild(notif);

        setTimeout(() => notif.classList.add('show'), 10);
        setTimeout(() => {
            notif.classList.remove('show');
            notif.addEventListener('transitionend', () => notif.remove());
        }, 3000);
    }

    function showConfirmation(message, onConfirm) {
        confirmationTitle.textContent = message;
        confirmationModal.classList.remove('hidden');

        const confirmHandler = () => {
            onConfirm();
            cleanup();
        };

        const cancelHandler = () => {
            cleanup();
        };
        
        function cleanup() {
            confirmationModal.classList.add('hidden');
            confirmBtnYes.removeEventListener('click', confirmHandler);
            confirmBtnNo.removeEventListener('click', cancelHandler);
        }

        confirmBtnYes.addEventListener('click', confirmHandler, { once: true });
        confirmBtnNo.addEventListener('click', cancelHandler, { once: true });
    }


    // --- Magnifier Functions ---
    function handleMouseLeave(event) {
        const popover = document.getElementById('magnifier-popover');
        if (popover) {
            popover.remove();
        }
    }
    
    async function handleMouseEnter(event) {
        const pageNum = parseInt(event.currentTarget.dataset.pageNumber, 10);
        if (!currentPdf || !pageNum) return;
    
        handleMouseLeave();
    
        const popover = document.createElement('div');
        popover.id = 'magnifier-popover';
        
        const loadingMessage = document.createElement('p');
        loadingMessage.textContent = 'Loading...';
        loadingMessage.className = 'p-4';
        popover.appendChild(loadingMessage);
        
        positionPopover(event, popover);
        
        document.body.appendChild(popover);
        
        const page = await currentPdf.getPage(pageNum);
        
        const magnifiedWidth = 500;
        const unscaledViewport = page.getViewport({ scale: 1.0 });
        const scale = magnifiedWidth / unscaledViewport.width;
        const viewport = page.getViewport({ scale: scale });
    
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
    
        await page.render({ canvasContext: context, viewport: viewport }).promise;
    
        popover.innerHTML = '';
        popover.appendChild(canvas);
    
        positionPopover(event, popover);
    }
    
    function positionPopover(mouseEvent, popoverElement) {
        const popoverRect = popoverElement.getBoundingClientRect();
        const offsetX = 15;
        const offsetY = 15;
    
        let top = mouseEvent.clientY + offsetY;
        let left = mouseEvent.clientX + offsetX;
    
        if (left + popoverRect.width > window.innerWidth) {
            left = mouseEvent.clientX - popoverRect.width - offsetX;
        }
        if (top + popoverRect.height > window.innerHeight) {
            top = mouseEvent.clientY - popoverRect.height - offsetY;
        }
    
        popoverElement.style.top = `${top}px`;
        popoverElement.style.left = `${left}px`;
    }

    // --- Initial Application Setup ---
    function init() {
        runSearchBtn.disabled = true; 
        fileInput.addEventListener('change', handleFileSelect);

        saveGroupBtn.addEventListener('click', saveSearchGroup);
        loadGroupBtn.addEventListener('click', loadSearchGroup);
        deleteGroupBtn.addEventListener('click', deleteSearchGroup);
        addRangeBtn.addEventListener('click', handleAddRange);
        addPageBtn.addEventListener('click', handleAddSinglePage);
        runSearchBtn.addEventListener('click', runSearch);
        openPdfBtn.addEventListener('click', openFilteredPdfInNewTab);

        initializeFirebase();
    }

    init(); 
</script>
